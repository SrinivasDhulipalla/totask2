<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title th:text="#{totask2.appname}">totask2 projects</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />	
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" type="text/css" href="/css/totask2.css" />
	<link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap-theme.min.css" />
	<link rel="stylesheet" type="text/css" href="/css/jquery.dataTables.css" />
</head>
<body> 
	<script type="text/javascript" charset="utf8" src="/js/jquery-1.11.1.js"></script>
	<script type="text/javascript" charset="utf8" src="/js/jquery.dataTables.js"></script>	
	<script type="text/javascript" charset="utf8" src="/bootstrap/js/bootstrap.min.js"></script>

    <!--/* 
    	this is the main entry page, allowing logging all work for task for a given week and user.
    	one row per task, one input per work day. 
    */-->
    
    
    <script type="text/javascript">
    /*<![CDATA[*/
               
        /* all css classnames for displayed tasks. */
		var taskClassNames = {};                             
               
	    /** register all callback javascript events. */
		$(document).ready(function()
		{ 
			$('#tableWeekEntry').dataTable();
			
	        taskClassNames = findAllClassesForTasks();
			
	        $('input').each(function() {
	            $(this).keyup(function(){   
	                calculateTotal();	/* calculate if value may changed */
	            })
	        });	
	        
	        $('#weekForm').submit(function( event ) {
       	  		if( ! validateFormBeforeSubmit())
          		{
       	  			event.preventDefault();
          		}
		    });    
	        
	        calculateTotal();  /* calculate on start */
		});
    
	    /** find all css class names for displayed task input fields. */
        function findAllClassesForTasks()
        {
	    	var taskRegEx = /task_\d*$/g;  /* matches task_123 */
	    	var classes = {};
	    	
			$('input').each(function() {
			  if($(this).attr('class') !== undefined ) {
				  
					    $($(this).attr('class').split(' ')).each(function() { 
					        if (this !== '' && taskRegEx.test(this) ) {
					            classes[this] = this;
					        }    
				    });
			   }
			});
			
			return classes;
        }
	    
		/** sum up all week entries in sum field */
	    function calculateTotal() 
	    {
	    	for (className in taskClassNames) {
				$('#' + className + '_total').html( sumOneTaskRow('.' + className).toFixed(1)); /* sum work hours for task ${taskInWeek.task.name} */
	    	}
	    	
	    	var weekSum = 0;
	    	for (i = 0; i <= 6; i++) { 
	    		var daySum = sumOneTaskRow('.day_' + i);
	    		weekSum   += daySum;
	    		$('#day_' + i + '_total').html(daySum.toFixed(1));
	    	}
	    	$('#week_total').html(weekSum.toFixed(1));	
	    }	    
	    
		/** sum all hours done for a task for complete week. */
	    function sumOneTaskRow( cssClassOfTask )
	    {
	        var sum = 0;
	        $(cssClassOfTask).each(function() {
	            if(!isNaN(this.value) && this.value.length!=0) {
	                sum += parseFloat(this.value);
	            }
	        });
	        return sum;    	
	    } 
		
		
	    function validateFormBeforeSubmit()
	    {
	        var isValidForm = true;
	        $('.validationDecimal').each(function() {
	            if( ! validateDecimal( this.value ))
	            {
	            	this.focus();
	            	this.select();
	    	        $("#errmsg").html("not a valid duration: " + this.value).show().fadeOut("slow");	//display error message
	        		isValidForm = false;
	            }
	        });
	        return isValidForm;
	    }

		/** check on valid decimal for us. */
	    function validateDecimal(value)    {
	        var RE = /^\d*\.?\d{0,2}$/
	        if(RE.test(value)){
	           return true;
	        }else{
	           return false;
	        }
	    }		
	/*]]>*/
    </script>
 
 <div class="container">
 	
	<div class="page-header">
		<h1 th:text="#{totask2.weekEntry.header}">edit this week</h1>
	</div>

	<ul class="nav nav-tabs" role="tablist">
	  <li><a th:href="@{/}" th:text="#{totask2.nav.home}">home</a></li>
	  <li><a th:href="@{/projects}" th:text="#{totask2.nav.projects}">projects</a></li>
	  <li class="active"><a href="#" th:text="#{totask2.nav.weekEntry}">home</a></li>
	</ul>	

	<div id="errsg" class="alert alert-danger" role="alert">
	</div>
	<span id="flashMessage" th:text="${flashMessage}">flashMessage</span>


	<div>
			<a th:href="@{/weekEntry/} + ${previousWeek}" class="btn btn-default">			
				<span class="glyphicon glyphicon-chevron-left"></span>
				<span th:text="#{totask2.weekEntry.action.previousWeek}">&lt;</span>				
			</a>		
			<b><span id="date" th:text="${#dates.format(date, 'dd.MM.yyyy')}"></span></b>
			
			<a th:href="@{/weekEntry/} + ${nextWeek}" class="btn btn-default">			
				<span class="glyphicon glyphicon-chevron-right"></span>
				<span th:text="#{totask2.weekEntry.action.nextWeek}">&gt;</span>				
			</a>			
			
			<br />
			<br />
	</div>	
	

	<form id="weekForm" action="#" th:action="@{/weekEntry/} + ${currentWeek}" method="post">
	
		
		<table id="tableWeekEntry"  class="display compact cell-border">
			<colgroup>
				<col /><col /><col /><col /><col /><col /><col /><col /><col />
			</colgroup>		
			<thead>
				<tr>
				    <th />
					<th th:text="#{totask2.weekEntry.monday.label}"     class="dt-left">Mo</th>
					<th th:text="#{totask2.weekEntry.tuesday.label}"    class="dt-left">Tue</th>
					<th th:text="#{totask2.weekEntry.wednesday.label}"  class="dt-left">Wed</th>
					<th th:text="#{totask2.weekEntry.thursday.label}"	class="dt-left">Thu</th>
					<th th:text="#{totask2.weekEntry.friday.label}"		class="dt-left">Fri</th>
					<th th:text="#{totask2.weekEntry.saturday.label}"	class="dt-left">Sat</th>
					<th th:text="#{totask2.weekEntry.sunday.label}"		class="dt-left">Sun</th>
					<th th:text="#{totask2.weekEntry.taskTotal.label}"	class="dt-left">total</th>
				</tr>
			</thead>
			<tbody>
				<tr id="taskRow_"  th:each="taskInWeek : ${tasksInWeek}" th:attrappend="id=${taskInWeek.task.id}">
				
					<td th:title="${taskInWeek.task.id}">
						<strong th:text="${taskInWeek.task.name}">
							ClearQuest development
						</strong>
					</td>
					
					<td th:each="dailyEntry, iterationStatus : ${taskInWeek.dailyEntries}">
					    <input 
					    	type="number" 
					    	name="workEntry_" 
					    	th:attrappend="name=${taskInWeek.task.id} + '_' + ${iterationStatus.index} " 
					    	th:classappend="'day_' + ${iterationStatus.index} + ' task_' + ${taskInWeek.task.id}"
					    	th:value="${dailyEntry.duration}" 
					    	th:title="${dailyEntry.id} + ' ' + ${dailyEntry.atDate} + ' ' + ${dailyEntry.comment}"
					    	value="1" 
					    	step="0.1"
					    	size="3"
					    	min="0"
					    	max="12"
					    	maxlength="4"/>
					</td>

					<td>
					<i>
						<span id="task_" th:attrappend="id=${taskInWeek.task.id} + '_total'" th:text="${taskInWeek.duration}">13.3</span>
					</i>
					</td>					
				</tr>
			</tbody>
			<tfoot>
				<tr>
					<td/>
					<td><i><span id="day_0_total">3.0</span></i></td>
					<td><i><span id="day_1_total">3.1</span></i></td>
					<td><i><span id="day_2_total">3.2</span></i></td>
					<td><i><span id="day_3_total">3.3</span></i></td>
					<td><i><span id="day_4_total">3.4</span></i></td>
					<td><i><span id="day_5_total">0.5</span></i></td>
					<td><i><span id="day_6_total">0.6</span></i></td>
					<td><i><span id="week_total">15.0</span></i></td>
				</tr>
			</tfoot>
		</table>
		
		<p>
			<input type="submit" class="btn btn-success btn-lg" th:value="#{totask2.weekEntry.save.label}" />
			
			&nbsp;&nbsp;
						
			<a th:href="@{/weekEntry/report/excel} + '/' + ${currentWeek}" class="btn btn-default">
					<span class="glyphicon glyphicon-print"></span>
					<span th:text="#{totask2.weekEntry.action.excelReport}">excel..</span>					
			</a>		
		</p>
			
	</form>
	
	<p>
	</p>

</div>
</body>
</html>
